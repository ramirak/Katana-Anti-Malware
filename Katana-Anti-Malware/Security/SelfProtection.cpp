#include <Windows.h>
#include <Aclapi.h>
#include <stdlib.h>

DWORD MakeST() {
	// Singleton
	CreateMutexA(0, FALSE, "Local\\$katana$"); // Try to create a named mutex
	if (GetLastError() == ERROR_ALREADY_EXISTS) // Does the mutex already exist?
		exit(EXIT_FAILURE); // quit; mutex is released automatically
	return 0;
}


DWORD ProtectProcess(void)
{
	HANDLE hProcess = GetCurrentProcess();
	PACL pEmptyDacl;
	DWORD dwErr;

	// using malloc guarantees proper alignment
	pEmptyDacl = (PACL)malloc(sizeof(ACL));

	if (!InitializeAcl(pEmptyDacl, sizeof(ACL), ACL_REVISION))
		dwErr = GetLastError();
	else
		dwErr = SetSecurityInfo(hProcess, SE_KERNEL_OBJECT,
			DACL_SECURITY_INFORMATION, NULL, NULL, pEmptyDacl, NULL);

	free(pEmptyDacl);
	return dwErr;
}